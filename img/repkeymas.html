<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Reportes de Excel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f0f2f5; 
            color: #333;
        }
        .container { 
            max-width: 900px; 
            margin: auto; 
            padding: 30px; 
            background: #fff; 
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        h1, h2, h3 { 
            color: #333; 
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            margin-top: 20px;
        }
        #upload-section { 
            margin-bottom: 20px; 
            padding: 20px; 
            border: 1px dashed #ccc; 
            border-radius: 8px; 
        }
        .report-section { 
            display: none; 
            margin-top: 30px; 
            padding: 20px; 
            border-top: 2px solid #e9ecef; 
        }
        .form-group { 
            margin-bottom: 15px; 
        }
        label { 
            font-weight: bold; 
            display: block; 
            margin-bottom: 5px; 
        }
        select, input[type="text"] { 
            width: 100%; 
            padding: 8px; 
            border-radius: 4px; 
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }
        button { 
            background-color: #007bff; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px; 
            transition: background-color 0.3s; 
        }
        button:hover { 
            background-color: #0056b3; 
        }
        #report-output {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
        }
        .report-row {
            border-bottom: 1px dashed #ddd;
            padding: 10px 0;
        }
        .report-row:last-child {
            border-bottom: none;
        }
        .report-row h4 {
            margin: 0;
            color: #007bff;
        }
        .report-row p {
            margin: 5px 0;
        }
        .conditional-text {
            font-weight: bold;
            color: #dc3545;
        }
        .promedio-value {
            font-weight: bold;
            color: #28a745;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Generador de Reportes de Excel</h1>
        
        <div id="upload-section">
            <h2>Paso 1: Sube tu archivo Excel</h2>
            <form id="upload-form">
                <input type="file" id="excelFile" name="excelFile" accept=".xlsx, .xls">
                <br><br>
                <button type="submit">Cargar Datos</button>
            </form>
        </div>

        <div class="report-section" id="options-section">
            <h2>Paso 2: Configura tu reporte</h2>
            <div class="form-group">
                <label for="display-columns-select">Selecciona las columnas a mostrar en el reporte (usa Ctrl/Cmd + clic):</label>
                <select id="display-columns-select" multiple size="5"></select>
            </div>
            
            <div class="form-group">
                <h3>Opciones de Promedio</h3>
                <label for="avg-column1-select">Columna 1 para calcular el promedio:</label>
                <select id="avg-column1-select"></select>
                <label for="avg-column2-select">Columna 2 para calcular el promedio:</label>
                <select id="avg-column2-select"></select>
            </div>
            
            <div class="form-group">
                <h3>Opciones para Celda Individual (Textos Fijos)</h3>
                <label for="single-column-select">Columna para textos condicionales:</label>
                <select id="single-column-select"></select>
            </div>

            <button id="generate-report-btn">Generar Reporte</button>
        </div>

        <div class="report-section" id="report-output-section">
            <h2>Paso 3: Reporte Generado</h2>
            <div id="report-output">
                </div>
        </div>
    </div>

    <script>
        let excelData = [];
        
        // Rangos y textos fijos para la celda individual (13)
        const fixedSingleConditions = [
            { min: 0, max: 80, text: 'NOT REPORTED IN MAIN SUITE EXAM' },
            { min: 80, max: 88.9, text: 'PRE A1 LOW' },
            { min: 90, max: 95.9, text: 'PRE A1 MIDDLE' },
            { min: 96, max: 99.9, text: 'PRE A1 HIGH' },
            { min: 100, max: 109.9, text: 'A1 LOW' },
            { min: 110, max: 114.9, text: 'A1 MIDDLE' },
            { min: 115, max: 119.9, text: 'A1 HIGH WITH PRACTICE CAN SET KEY EXAM' },
            { min: 120, max: 129, text: 'A2 LOW, READY FOR KEY' },
            { min: 130, max: 135.9, text: 'A2 MIDDLE READY FOR KEY' },
            { min: 136, max: 139.9, text: 'A2 HIGH READY FOR KEY' },
            { min: 140, max: 149.9, text: 'B1 LOW READY FOR PET' },
            { min: 150, max: 155.9, text: 'B1 MIDDLE READY FOR PET' },
	{ min: 156, max: 159.9, text: 'B1 HIGH READY FOR PET' },
	{ min: 160, max: 169.9, text: 'B2 LOW READY FOR FCE' },
	{ min: 170, max: 176.9, text: 'B2 MIDDLE READY FOR FCE' },
	{ min: 177, max: 179.9, text: 'B2 HIGH READY FOR FCE' },
	{ min: 180, max: 189.9, text: 'C1 LOW READY FOR CAE' },
	{ min: 190, max: 196.9, text: 'C1 MIDDLE READY FOR CAE' },
	{ min: 197, max: 200, text: 'C1 HIGH READY FOR CAE' },

            { min: 201, max: Infinity, text: 'C2' }
        ];

        // Función para manejar la carga del archivo
        document.getElementById('upload-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const file = document.getElementById('excelFile').files[0];
            if (!file) {
                alert('Por favor, selecciona un archivo primero.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (excelData.length === 0) {
                    alert('El archivo de Excel está vacío.');
                    return;
                }

                const headers = excelData[0];
                const displaySelect = document.getElementById('display-columns-select');
                const avg1Select = document.getElementById('avg-column1-select');
                const avg2Select = document.getElementById('avg-column2-select');
                const singleSelect = document.getElementById('single-column-select');
                
                displaySelect.innerHTML = '';
                avg1Select.innerHTML = '';
                avg2Select.innerHTML = '';
                singleSelect.innerHTML = '';

                headers.forEach((header, index) => {
                    const optionDisplay = document.createElement('option');
                    optionDisplay.value = index;
                    optionDisplay.textContent = header || `Columna ${String.fromCharCode(65 + index)}`;
                    displaySelect.appendChild(optionDisplay);
                    
                    const optionAvg1 = optionDisplay.cloneNode(true);
                    avg1Select.appendChild(optionAvg1);

                    const optionAvg2 = optionDisplay.cloneNode(true);
                    avg2Select.appendChild(optionAvg2);

                    const optionSingle = optionDisplay.cloneNode(true);
                    singleSelect.appendChild(optionSingle);
                });

                document.getElementById('options-section').style.display = 'block';
            };
            reader.readAsArrayBuffer(file);
        });

        // Evento para generar el reporte
        document.getElementById('generate-report-btn').addEventListener('click', function() {
            const displayColumnsSelect = document.getElementById('display-columns-select');
            const selectedDisplayIndices = Array.from(displayColumnsSelect.selectedOptions).map(opt => parseInt(opt.value));
            
            const avgColumn1Index = parseInt(document.getElementById('avg-column1-select').value);
            const avgColumn2Index = parseInt(document.getElementById('avg-column2-select').value);
            const singleColumnIndex = parseInt(document.getElementById('single-column-select').value);

            if (selectedDisplayIndices.length === 0) {
                alert('Por favor, selecciona al menos una columna para mostrar.');
                return;
            }

            const reportOutput = document.getElementById('report-output');
            reportOutput.innerHTML = ''; 
            
            const headers = excelData[0];
            const dataRows = excelData.slice(1);

            dataRows.forEach((row, rowIndex) => {
                // Cálculo del promedio
                const value1 = parseFloat(row[avgColumn1Index]);
                const value2 = parseFloat(row[avgColumn2Index]);
                let average = NaN;
                if (!isNaN(value1) && !isNaN(value2)) {
                    average = (value1 + value2) / 2;
                }
                
                // Obtener texto condicional de la celda individual (fijos)
                const singleValue = parseFloat(row[singleColumnIndex]);
                let singleConditionalText = '';
                if (!isNaN(singleValue)) {
                    for (const condition of fixedSingleConditions) {
                        if (singleValue >= condition.min && singleValue <= condition.max) {
                            singleConditionalText = condition.text;
                            break;
                        }
                    }
                }

                const reportRow = document.createElement('div');
                reportRow.className = 'report-row';
                
                let rowContent = `<h4>Reporte de Fila ${rowIndex + 1}</h4>`;
                
                selectedDisplayIndices.forEach(index => {
                    const cellValue = row[index] !== undefined ? row[index] : '';
                    rowContent += `<p><strong>${headers[index]}:</strong> ${cellValue}</p>`;
                });

                if (!isNaN(average)) {
                    rowContent += `<p class="promedio-value"><strong>Promedio de ${headers[avgColumn1Index]} y ${headers[avgColumn2Index]}:</strong> ${average.toFixed(2)}</p>`;
                }
                
                if (singleConditionalText) {
                    rowContent += `<p class="conditional-text">Nota (${headers[singleColumnIndex]}): ${singleConditionalText}</p>`;
                }

                reportRow.innerHTML = rowContent;
                reportOutput.appendChild(reportRow);
            });

            document.getElementById('report-output-section').style.display = 'block';
        });
    </script>
</body>
</html>