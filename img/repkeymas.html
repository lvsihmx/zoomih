<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Generador de Reportes de Excel</title>

  <!-- Librerías -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f0f2f5;
      color: #333;
    }
    .container {
      max-width: 900px;
      margin: auto;
      padding: 30px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    h1, h2, h3 {
      color: #333;
      border-bottom: 2px solid #007bff;
      padding-bottom: 5px;
      margin-top: 20px;
    }
    #upload-section {
      margin-bottom: 20px;
      padding: 20px;
      border: 1px dashed #ccc;
      border-radius: 8px;
    }
    .report-section {
      display: none;
      margin-top: 30px;
      padding: 20px;
      border-top: 2px solid #e9ecef;
    }
    .form-group { margin-bottom: 15px; }
    label { font-weight: bold; display: block; margin-bottom: 5px; }
    select, input[type="text"] {
      width: 100%;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
      box-sizing: border-box;
    }
    button {
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
      margin-top: 10px;
      margin-right: 10px;
    }
    button:hover { background-color: #0056b3; }
    #download-pdf-btn { background-color: #28a745; }
    #download-pdf-btn:hover { background-color: #218838; }
    #print-report-btn { background-color: #ffc107; color: #000; }
    #print-report-btn:hover { background-color: #e0a800; }
    #email-report-btn { background-color: #6c757d; }
    #email-report-btn:hover { background-color: #5a6268; }
    #download-excel-btn { background-color: #17a2b8; }
    #download-excel-btn:hover { background-color: #117a8b; }
    #report-output { border: 1px solid #ccc; border-radius: 5px; overflow-x: auto; }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: left;
      font-size: 10pt;
    }
    th {
      background-color: #007bff;
      color: white;
      font-size: 10pt;
    }
    .conditional-text { font-weight: bold; color: #dc3545; }
    .promedio-value { font-weight: bold; color: #28a745; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Generador de Reportes de Excel</h1>

    <div id="upload-section">
      <h2>Paso 1: Sube tu archivo Excel</h2>
      <form id="upload-form">
        <input type="file" id="excelFile" name="excelFile" accept=".xlsx, .xls"/>
        <br/><br/>
        <button type="submit">Cargar Datos</button>
      </form>
    </div>

    <div class="report-section" id="options-section">
      <h2>Paso 2: Configura tu reporte</h2>
      <div class="form-group">
        <label for="display-columns-select">Selecciona las columnas a mostrar (Ctrl + clic):</label>
        <select id="display-columns-select" multiple size="5"></select>
      </div>

      <div class="form-group">
        <h3>Opciones de Promedio</h3>
        <label for="avg-column1-select">Columna 1:</label>
        <select id="avg-column1-select"></select>
        <label for="avg-column2-select">Columna 2:</label>
        <select id="avg-column2-select"></select>
      </div>

      <div class="form-group">
        <h3>Nivel</h3>
        <label for="single-column-select">Columna para nivel:</label>
        <select id="single-column-select"></select>
      </div>

      <div class="form-group">
        <label for="file-name-input">Nombre del archivo (sin extensión):</label>
        <input type="text" id="file-name-input" value="reporte" />
      </div>

      <button id="generate-report-btn">Generar Reporte</button>
      <button id="download-pdf-btn" style="display: none;">Descargar PDF</button>
      <button id="download-excel-btn" style="display: none;">Descargar Excel</button>
      <button id="print-report-btn" style="display: none;">Imprimir</button>
      <button id="email-report-btn" style="display: none;">Enviar por Correo</button>
    </div>

    <div class="report-section" id="report-output-section">
      <h2>Paso 3: Reporte Generado</h2>
      <div id="report-output"></div>
    </div>
  </div>

  <script>
    let excelData = [];

    const fixedSingleConditions = [
      { min: 0, max: 80, text: 'NOT REPORTED IN MAIN SUITE EXAM' },
      { min: 80, max: 88.9, text: 'PRE A1 LOW' },
      { min: 90, max: 95.9, text: 'PRE A1 MIDDLE' },
      { min: 96, max: 99.9, text: 'PRE A1 HIGH' },
      { min: 100, max: 109.9, text: 'A1 LOW' },
      { min: 110, max: 114.9, text: 'A1 MIDDLE' },
      { min: 115, max: 119.9, text: 'A1 HIGH WITH PRACTICE CAN SET KEY EXAM' },
      { min: 120, max: 129, text: 'A2 LOW, READY FOR KEY' },
      { min: 130, max: 135.9, text: 'A2 MIDDLE READY FOR KEY' },
      { min: 136, max: 139.9, text: 'A2 HIGH READY FOR KEY' },
      { min: 140, max: 149.9, text: 'B1 LOW READY FOR PET' },
      { min: 150, max: 155.9, text: 'B1 MIDDLE READY FOR PET' },
      { min: 156, max: 159.9, text: 'B1 HIGH READY FOR PET' },
      { min: 160, max: 169.9, text: 'B2 LOW READY FOR FCE' },
      { min: 170, max: 176.9, text: 'B2 MIDDLE READY FOR FCE' },
      { min: 177, max: 179.9, text: 'B2 HIGH READY FOR FCE' },
      { min: 180, max: 189.9, text: 'C1 LOW READY FOR CAE' },
      { min: 190, max: 196.9, text: 'C1 MIDDLE READY FOR CAE' },
      { min: 197, max: 200, text: 'C1 HIGH READY FOR CAE' },
      { min: 201, max: Infinity, text: 'C2' }
    ];

    // --- Cargar archivo Excel ---
    document.getElementById('upload-form').addEventListener('submit', function (e) {
      e.preventDefault();
      const file = document.getElementById('excelFile').files[0];
      if (!file) return alert('Por favor, selecciona un archivo Excel.');

      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

        if (excelData.length === 0) return alert('El archivo está vacío.');

        const headers = excelData[0];
        ['display-columns-select', 'avg-column1-select', 'avg-column2-select', 'single-column-select'].forEach(id => {
          const select = document.getElementById(id);
          select.innerHTML = '';
          headers.forEach((header, index) => {
            const opt = document.createElement('option');
            opt.value = index;
            opt.textContent = header || `Columna ${index}`;
            select.appendChild(opt.cloneNode(true));
          });
        });

        document.getElementById('options-section').style.display = 'block';
      };
      reader.readAsArrayBuffer(file);
    });

    // --- Generar reporte ---
    document.getElementById('generate-report-btn').addEventListener('click', function () {
      const headers = excelData[0];
      const rows = excelData.slice(1);
      const displayIndices = Array.from(document.getElementById('display-columns-select').selectedOptions).map(opt => +opt.value);
      const avg1 = +document.getElementById('avg-column1-select').value;
      const avg2 = +document.getElementById('avg-column2-select').value;
      const single = +document.getElementById('single-column-select').value;

      if (!displayIndices.length) return alert('Selecciona al menos una columna.');

      const output = document.getElementById('report-output');
      output.innerHTML = '';

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');

      displayIndices.forEach(index => {
        const th = document.createElement('th');
        th.textContent = headers[index];
        headerRow.appendChild(th);
      });

      const thAvg = document.createElement('th');
      thAvg.textContent = 'Promedio';
      headerRow.appendChild(thAvg);

      const thCond = document.createElement('th');
      thCond.textContent = 'Nivel';
      headerRow.appendChild(thCond);

      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');

      rows.forEach(row => {
        const tr = document.createElement('tr');
        displayIndices.forEach(index => {
          const td = document.createElement('td');
          td.textContent = row[index] ?? '';
          tr.appendChild(td);
        });

        const v1 = parseFloat(row[avg1]);
        const v2 = parseFloat(row[avg2]);
        const avgTD = document.createElement('td');

        if (!isNaN(v1) && !isNaN(v2)) {
          avgTD.textContent = ((v1 + v2) / 2).toFixed(2);
          avgTD.classList.add('promedio-value');
        } else {
          avgTD.textContent = '';
        }
        tr.appendChild(avgTD);

        const val = parseFloat(row[single]);
        const condTD = document.createElement('td');
        if (!isNaN(val)) {
          const match = fixedSingleConditions.find(c => val >= c.min && val <= c.max);
          condTD.textContent = match ? match.text : '';
          condTD.classList.add('conditional-text');
        }
        tr.appendChild(condTD);
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      output.appendChild(table);
      document.getElementById('report-output-section').style.display = 'block';
      document.getElementById('download-pdf-btn').style.display = 'inline-block';
      document.getElementById('download-excel-btn').style.display = 'inline-block';
      document.getElementById('print-report-btn').style.display = 'inline-block';
      document.getElementById('email-report-btn').style.display = 'inline-block';
    });

    // --- Descargar PDF con logo centrado y ancho completo ---
    document.getElementById('download-pdf-btn').addEventListener('click', () => {
      const filename = document.getElementById('file-name-input').value.trim() || 'reporte';
      const table = document.querySelector('#report-output table');
      if (!table) return alert('No hay reporte generado.');

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'letter' });
      const logo = new Image();
      logo.src = 'https://lvsihmx.github.io/zoomih/img/ihmock.png';

      logo.onload = () => {
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();

        const desiredWidth = pageWidth - 80;
        const scale = desiredWidth / logo.width;
        const logoWidth = desiredWidth;
        const logoHeight = logo.height * scale;
        const xCentered = (pageWidth - logoWidth) / 2;
        const yPosition = 20;

        doc.addImage(logo, 'PNG', xCentered, yPosition, logoWidth, logoHeight);

        doc.autoTable({
          html: table,
          startY: yPosition + logoHeight + 30,
          styles: { fontSize: 8, cellPadding: 4 },
          headStyles: { fillColor: [0, 123, 255], textColor: 255 },
          alternateRowStyles: { fillColor: [240, 240, 240] },
          margin: { top: 70, left: 40, right: 40, bottom: 40 },
          didDrawPage: function (data) {
            const lineY = yPosition + logoHeight + 15;
            doc.setDrawColor(0);
            doc.line(40, lineY, pageWidth - 40, lineY);

            const pageCount = doc.internal.getNumberOfPages();
            doc.setFontSize(9);
            doc.text('Página ' + pageCount, pageWidth - 70, pageHeight - 10);
          }
        });

        doc.save(filename + '.pdf');
      };
    });
  </script>
</body>
</html>
